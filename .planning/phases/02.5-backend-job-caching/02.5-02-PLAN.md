---
phase: 02.5-backend-job-caching
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/hooks/useLaneJobs.ts
  - src/hooks/useJobs.ts
  - src/services/jsearch.ts
autonomous: false

user_setup:
  - service: supabase-extensions
    why: "pg_cron and Vault extensions may need enabling on free tier"
    dashboard_config:
      - task: "Enable pg_cron extension (if not already enabled)"
        location: "Supabase Dashboard -> Database -> Extensions -> Search 'pg_cron' -> Enable"
      - task: "Enable vault extension (if not already enabled)"
        location: "Supabase Dashboard -> Database -> Extensions -> Search 'vault' -> Enable"
      - task: "Enable pg_net extension for HTTP requests from cron"
        location: "Supabase Dashboard -> Database -> Extensions -> Search 'pg_net' -> Enable"
  - service: supabase-vault
    why: "pg_cron needs secrets stored in Vault for Edge Function invocation"
    dashboard_config:
      - task: "Store project_url and service_role_key in Vault"
        location: "Supabase Dashboard -> SQL Editor (run Vault SQL commands in Task 2)"

must_haves:
  truths:
    - "Database migration applied successfully"
    - "Edge Function deployed and callable"
    - "Frontend loads jobs from Supabase cache (not JSearch API)"
    - "Page load completes in under 2 seconds"
    - "Jobs display correctly in Kanban lanes"
    - "pg_cron schedule triggers daily job refresh"
  artifacts:
    - path: "src/hooks/useLaneJobs.ts"
      provides: "React Query hook querying cached jobs"
      contains: "supabase.from('jobs')"
    - path: "src/services/jsearch.ts"
      provides: "Deprecated file (can be deleted or kept)"
      note: "No longer called from frontend"
  key_links:
    - from: "src/hooks/useLaneJobs.ts"
      to: "Supabase jobs table"
      via: "direct query with is_active filter"
      pattern: "\\.eq\\('is_active', true\\)"
    - from: "pg_cron"
      to: "Edge Function"
      via: "net.http_post via Vault secrets"
      pattern: "cron.schedule"
---

<objective>
Deploy Edge Function, run migration, refactor frontend to use cached data, and set up pg_cron for automated refresh.

Purpose: Completes the backend caching architecture - database populated, frontend gets instant cached data, backend refreshes daily.

Output: Fast-loading frontend (<2 sec) with automatic daily job refresh.
</objective>

<execution_context>
@C:\Users\thedi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thedi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-backend-job-caching/02.5-CONTEXT.md
@.planning/phases/02.5-backend-job-caching/02.5-01-SUMMARY.md

@src/hooks/useLaneJobs.ts
@src/hooks/useJobs.ts
@src/services/jsearch.ts
@src/services/supabase.ts
@src/types/job.ts
@supabase/migrations/20260202_add_job_caching.sql
@supabase/functions/job-sync/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy migration and Edge Function to Supabase</name>
  <files>supabase/migrations/20260202_add_job_caching.sql, supabase/functions/job-sync/index.ts</files>
  <action>
Deploy the migration and Edge Function created in Plan 01:

1. **Run database migration**:
   - Use Supabase CLI: `supabase db push` (applies local migrations)
   - OR copy migration SQL and run in Supabase Dashboard -> SQL Editor
   - Verify columns exist: `SELECT column_name FROM information_schema.columns WHERE table_name = 'jobs' ORDER BY ordinal_position`

2. **Deploy Edge Function**:
   ```bash
   # Ensure project is linked
   supabase link --project-ref YOUR_PROJECT_REF

   # Set JSEARCH_API_KEY secret
   supabase secrets set JSEARCH_API_KEY=your_jsearch_api_key

   # Deploy function
   supabase functions deploy job-sync
   ```

3. **Trigger initial job sync**:
   ```bash
   curl -X POST "https://YOUR_PROJECT_REF.supabase.co/functions/v1/job-sync" \
     -H "Authorization: Bearer YOUR_SERVICE_ROLE_KEY" \
     -H "Content-Type: application/json"
   ```

4. **Verify jobs populated**:
   - Check Supabase Dashboard -> Table Editor -> jobs
   - Should see jobs with all JSearch fields populated
   - is_active should be true, last_seen should be recent

**If Supabase CLI auth fails:** Claude should pause and create a checkpoint for user to authenticate. This is an expected auth gate, not a failure.

**Get credentials from:**
- Project ref: Supabase Dashboard URL (https://app.supabase.com/project/YOUR_PROJECT_REF)
- Service role key: Supabase Dashboard -> Settings -> API -> service_role (secret)
- JSEARCH API key: Same as VITE_JSEARCH_API_KEY from .env.local
  </action>
  <verify>
1. `supabase functions list` shows job-sync as deployed
2. `SELECT COUNT(*) FROM jobs WHERE is_active = true` returns > 0
3. Jobs have all fields populated (job_title, employer_name, etc.)
4. No errors in Edge Function logs (Dashboard -> Edge Functions -> job-sync -> Logs)
  </verify>
  <done>
- Database migration applied (all JSearch columns exist)
- Edge Function deployed to Supabase
- Initial job sync completed (jobs table populated)
- Jobs visible in Supabase with is_active=true
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor frontend to query Supabase cache</name>
  <files>src/hooks/useLaneJobs.ts, src/hooks/useJobs.ts, src/services/jsearch.ts</files>
  <action>
Refactor frontend data fetching to use cached Supabase data instead of JSearch API:

1. **Update useLaneJobs.ts**:
   - Remove import of useJobs hook
   - Single query to Supabase jobs table with `is_active = true` filter
   - Select all job fields + click_count + lane
   - Default lane to 'new' and click_count to 0 for jobs without engagement data
   - Keep the jobsByLane grouping logic (organize by lane)

```typescript
// New query pattern:
const { data: jobs, isLoading, error } = useQuery({
  queryKey: ['cached-jobs'],
  queryFn: async () => {
    const { data, error } = await supabase
      .from('jobs')
      .select('*')
      .eq('is_active', true)
      .order('last_seen', { ascending: false });
    if (error) throw error;
    return data;
  },
  staleTime: 1000 * 60 * 5, // 5 minutes - data refreshed daily by backend
});
```

2. **Group jobs by lane**:
   - Jobs with lane column use that value
   - Jobs without lane default to 'new'
   - Jobs without click_count default to 0

3. **Remove JSearch API dependency**:
   - useLaneJobs no longer imports useJobs
   - All data comes from single Supabase query

4. **Deprecate legacy files** (add comments, don't delete):
   - useJobs.ts: Add `@deprecated` JSDoc comment at top
   - jsearch.ts: Add `@deprecated` JSDoc comment at top
   - Keep files for reference but they're no longer called

The key change: Instead of fetching from JSearch API per-user, we fetch from Supabase cache which is populated by the Edge Function.
  </action>
  <verify>
1. Run `npm run dev`
2. Open browser, connect wallet
3. Verify jobs load from Supabase (check Network tab - should see supabase.co requests, NOT jsearch.p.rapidapi.com)
4. Verify Kanban board displays correctly with jobs in lanes
5. Check console for any errors
6. Page should load noticeably faster than before
  </verify>
  <done>
- useLaneJobs queries Supabase directly with is_active filter
- No JSearch API calls from frontend
- Jobs display in correct lanes based on lane column
- Loading state works correctly
- Error handling works correctly
- Legacy files marked as deprecated
  </done>
</task>

<task type="auto">
  <name>Task 3: Set up pg_cron schedule for daily refresh</name>
  <files>supabase/migrations/20260202_setup_job_sync_cron.sql</files>
  <action>
Create and execute SQL to set up scheduled job sync using pg_cron and Vault.

**PREREQUISITE CHECK**: Before running, verify extensions are enabled:
```sql
-- Check if extensions are available
SELECT * FROM pg_extension WHERE extname IN ('pg_cron', 'vault', 'pg_net');
```

If any are missing, user must enable them in Dashboard -> Database -> Extensions first.

1. **Store secrets in Vault** (run in Supabase SQL Editor):
```sql
-- Store project URL (replace YOUR_PROJECT_REF)
SELECT vault.create_secret(
  'https://YOUR_PROJECT_REF.supabase.co',
  'project_url'
);

-- Store service role key (replace YOUR_SERVICE_ROLE_KEY)
SELECT vault.create_secret(
  'YOUR_SERVICE_ROLE_KEY',
  'service_role_key'
);
```

2. **Schedule daily job sync** (run in Supabase SQL Editor):
```sql
-- Schedule job-sync Edge Function to run daily at 6 AM UTC
SELECT cron.schedule(
  'job-sync-daily',
  '0 6 * * *',  -- Cron syntax: minute hour day month weekday
  $$
  SELECT net.http_post(
    url := (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'project_url') || '/functions/v1/job-sync',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'service_role_key')
    ),
    body := jsonb_build_object(
      'scheduled', true,
      'timestamp', NOW()
    )::text
  ) AS request_id;
  $$
);
```

3. **Create migration file** with all SQL for documentation:
   - Extension check
   - Vault secrets
   - Cron schedule creation
   - Comments explaining each step

4. **Verify cron job created**:
```sql
-- View scheduled jobs
SELECT * FROM cron.job;

-- View recent execution history (will be empty until first run)
SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 5;
```

Daily schedule at 6 AM UTC:
- Uses only 30 API requests/month (30 days)
- Preserves 93% of 500 req/month quota for manual triggers
- Fresh data each morning for US users
  </action>
  <verify>
1. Extensions enabled: `SELECT * FROM pg_extension WHERE extname IN ('pg_cron', 'vault', 'pg_net')` returns all 3
2. Vault secrets exist: `SELECT name FROM vault.secrets` shows project_url and service_role_key
3. Cron job scheduled: `SELECT * FROM cron.job WHERE jobname = 'job-sync-daily'` returns 1 row
4. Manual test: Run the net.http_post SELECT directly to verify it triggers the function
  </verify>
  <done>
- pg_cron, vault, pg_net extensions enabled
- project_url stored in Vault
- service_role_key stored in Vault
- Cron job 'job-sync-daily' scheduled for 6 AM UTC
- Manual trigger via SQL works
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete backend caching architecture:
- Database schema with all JSearch fields + caching columns
- Edge Function deployed and tested
- Frontend refactored to query Supabase cache
- pg_cron scheduled for automated daily refresh at 6 AM UTC
  </what-built>
  <how-to-verify>
1. **Performance Test**:
   - Open browser DevTools -> Network tab
   - Navigate to the app (or refresh if already open)
   - Measure time from navigation to jobs displayed
   - Target: Under 2 seconds (vs previous slow load)
   - Verify NO requests to jsearch.p.rapidapi.com
   - Should see requests to YOUR_PROJECT_REF.supabase.co

2. **Functionality Test**:
   - Verify jobs display in Kanban board (New, Trending, Graduated lanes)
   - Click Quick Apply - verify click tracking still works
   - Verify lane migrations still work (if threshold crossed)
   - Check "Already Applied" badges appear for clicked jobs
   - Verify all job data displays (title, company, location, salary if available)

3. **Cache Verification**:
   - Open Supabase Dashboard -> Table Editor -> jobs
   - Verify jobs have is_active=true and recent last_seen
   - Verify all JSearch fields populated (job_title, employer_name, job_city, etc.)
   - Verify click_count and lane values preserved for any engaged jobs

4. **Cron Verification**:
   - Supabase Dashboard -> SQL Editor
   - Run: `SELECT * FROM cron.job WHERE jobname = 'job-sync-daily'`
   - Verify job exists with schedule '0 6 * * *'
   - Run: `SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 5` (may be empty if never run yet)

5. **Manual Refresh Test** (optional):
   - Trigger manual refresh via: Dashboard -> Edge Functions -> job-sync -> Test
   - Verify Edge Function logs show successful execution
   - Verify jobs table last_seen timestamps updated
  </how-to-verify>
  <resume-signal>Type "approved" if performance improved and all features work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Database has full JSearch schema + caching columns
2. Edge Function deployed and returns jobs
3. Frontend loads jobs from Supabase cache (Network tab shows no JSearch requests)
4. Page load time under 2 seconds
5. Kanban board displays correctly with jobs in proper lanes
6. Click tracking and lane migrations work as before
7. pg_cron job scheduled for daily 6 AM UTC refresh
8. Manual refresh endpoint works for debugging
</verification>

<success_criteria>
- Page load time < 2 seconds (verified by user)
- No JSearch API calls from frontend
- All existing features (lanes, clicks, badges) work correctly
- Automated daily job refresh configured
- Phase 2.5 performance goal achieved
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-backend-job-caching/02.5-02-SUMMARY.md`
</output>
