---
phase: 02.5-backend-job-caching
plan: 02
type: execute
wave: 2
depends_on: ["02.5-01"]
files_modified:
  - src/hooks/useLaneJobs.ts
  - src/services/jsearch.ts
  - src/hooks/useJobs.ts
autonomous: false

user_setup:
  - service: supabase-vault
    why: "pg_cron needs secrets stored in Vault for Edge Function invocation"
    dashboard_config:
      - task: "Store project_url and service_role_key in Vault"
        location: "Supabase Dashboard -> SQL Editor (run Vault SQL commands)"

must_haves:
  truths:
    - "Frontend loads jobs from Supabase cache (not JSearch API)"
    - "Page load completes in under 2 seconds"
    - "Jobs display correctly in Kanban lanes"
    - "pg_cron schedule triggers daily job refresh"
  artifacts:
    - path: "src/hooks/useLaneJobs.ts"
      provides: "React Query hook querying cached jobs"
      contains: "supabase.from('jobs')"
    - path: "src/services/jsearch.ts"
      provides: "Deprecated file (can be deleted or kept)"
      note: "No longer called from frontend"
  key_links:
    - from: "src/hooks/useLaneJobs.ts"
      to: "Supabase jobs table"
      via: "direct query with is_active filter"
      pattern: "\\.eq\\('is_active', true\\)"
    - from: "pg_cron"
      to: "Edge Function"
      via: "net.http_post via Vault secrets"
      pattern: "cron.schedule"
---

<objective>
Refactor frontend to query cached jobs from Supabase instead of JSearch API, and set up pg_cron for automated daily refresh.

Purpose: Completes the backend caching architecture - frontend gets instant cached data, backend refreshes periodically.

Output: Fast-loading frontend (<2 sec) with automatic daily job refresh.
</objective>

<execution_context>
@C:\Users\thedi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thedi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-backend-job-caching/02.5-CONTEXT.md
@.planning/phases/02.5-backend-job-caching/02.5-RESEARCH.md
@.planning/phases/02.5-backend-job-caching/02.5-01-SUMMARY.md

@src/hooks/useLaneJobs.ts
@src/hooks/useJobs.ts
@src/services/jsearch.ts
@src/services/supabase.ts
@src/types/job.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor useLaneJobs to query Supabase directly</name>
  <files>src/hooks/useLaneJobs.ts, src/hooks/useJobs.ts</files>
  <action>
Refactor the frontend data fetching to use cached Supabase data instead of JSearch API:

1. **Update useLaneJobs.ts**:
   - Remove import of useJobs hook
   - Single query to Supabase jobs table with `is_active = true` filter
   - Select all job fields + click_count + lane
   - Default lane to 'new' and click_count to 0 for jobs without engagement data
   - Keep the jobsByLane grouping logic (organize by lane)

```typescript
// New query pattern:
const { data: jobs, isLoading, error } = useQuery({
  queryKey: ['cached-jobs'],
  queryFn: async () => {
    const { data, error } = await supabase
      .from('jobs')
      .select('*')
      .eq('is_active', true)
      .order('last_seen', { ascending: false });
    if (error) throw error;
    return data;
  },
  staleTime: 1000 * 60 * 5, // 5 minutes - data refreshed daily by backend
});
```

2. **Group jobs by lane**:
   - Jobs with lane column use that value
   - Jobs without lane default to 'new'
   - Jobs without click_count default to 0

3. **Remove JSearch API dependency**:
   - useLaneJobs no longer imports useJobs
   - All data comes from single Supabase query

4. **Update useJobs.ts** (deprecate):
   - Add deprecation comment at top of file
   - Keep file for reference but it's no longer used
   - OR delete file if preferred (cleaner codebase)

5. **Handle jsearch.ts**:
   - Add deprecation comment
   - Keep file for reference OR delete
   - File is no longer called from frontend

The key change: Instead of fetching from JSearch API per-user, we fetch from Supabase cache which is populated by the Edge Function.
  </action>
  <verify>
1. Run `npm run dev`
2. Open browser, connect wallet
3. Verify jobs load from Supabase (check Network tab - should see supabase.co requests, NOT jsearch.p.rapidapi.com)
4. Verify Kanban board displays correctly with jobs in lanes
5. Check console for any errors
6. Page should load noticeably faster than before
  </verify>
  <done>
- useLaneJobs queries Supabase directly with is_active filter
- No JSearch API calls from frontend
- Jobs display in correct lanes based on lane column
- Loading state works correctly
- Error handling works correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Set up pg_cron schedule with Vault secrets</name>
  <files>supabase/migrations/20260202_setup_job_sync_cron.sql</files>
  <action>
Create SQL migration to set up scheduled job sync using pg_cron and Supabase Vault:

1. **Store secrets in Vault** (run in Supabase SQL Editor):
```sql
-- Store project URL (get from Supabase Dashboard -> Settings -> API)
SELECT vault.create_secret(
  'https://YOUR_PROJECT_REF.supabase.co',
  'project_url'
);

-- Store service role key (get from Supabase Dashboard -> Settings -> API -> service_role key)
SELECT vault.create_secret(
  'YOUR_SERVICE_ROLE_KEY',
  'service_role_key'
);
```

2. **Schedule daily job sync**:
```sql
-- Schedule job-sync Edge Function to run daily at 6 AM UTC
SELECT cron.schedule(
  'job-sync-daily',
  '0 6 * * *',  -- Cron syntax: minute hour day month weekday
  $$
  SELECT net.http_post(
    url := (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'project_url') || '/functions/v1/job-sync',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'service_role_key')
    ),
    body := jsonb_build_object(
      'scheduled', true,
      'timestamp', NOW()
    )::text
  ) AS request_id;
  $$
);
```

3. **Create migration file** with all SQL:
   - First-time setup: Vault secrets
   - Cron schedule creation
   - Comments for documentation

4. **Verify cron job created**:
```sql
-- View scheduled jobs
SELECT * FROM cron.job;

-- View recent execution history (will be empty until first run)
SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 5;
```

IMPORTANT: Replace YOUR_PROJECT_REF and YOUR_SERVICE_ROLE_KEY with actual values from Supabase Dashboard.

Daily schedule at 6 AM UTC:
- Uses only 30 API requests/month (30 days)
- Preserves 93% of 500 req/month quota for manual triggers
- Fresh data each morning for US users
  </action>
  <verify>
1. Run Vault secret creation SQL in Supabase SQL Editor
2. Run cron.schedule SQL in Supabase SQL Editor
3. Verify cron job: `SELECT * FROM cron.job WHERE jobname = 'job-sync-daily'`
4. Manual trigger to test: Run the net.http_post SELECT statement directly
5. Check Edge Function logs for invocation
  </verify>
  <done>
- project_url stored in Vault
- service_role_key stored in Vault
- Cron job 'job-sync-daily' scheduled for 6 AM UTC
- Cron job visible in cron.job table
- Manual trigger via SQL works
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete backend caching architecture:
- Edge Function fetches jobs from JSearch API daily
- Jobs cached in Supabase with engagement data preserved
- Frontend queries Supabase cache directly (no JSearch API calls)
- pg_cron scheduled for automated daily refresh
  </what-built>
  <how-to-verify>
1. **Performance Test**:
   - Open browser DevTools -> Network tab
   - Navigate to the app
   - Measure time from navigation to jobs displayed
   - Target: Under 2 seconds (vs previous slow load)
   - Verify NO requests to jsearch.p.rapidapi.com

2. **Functionality Test**:
   - Verify jobs display in Kanban board
   - Click Quick Apply - verify click tracking still works
   - Verify lane migrations still work (if threshold crossed)
   - Check "Already Applied" badges appear for clicked jobs

3. **Cache Verification**:
   - Open Supabase Dashboard -> Table Editor -> jobs
   - Verify jobs have is_active=true and recent last_seen
   - Verify click_count and lane values preserved for engaged jobs

4. **Cron Verification**:
   - Supabase Dashboard -> SQL Editor
   - Run: `SELECT * FROM cron.job WHERE jobname = 'job-sync-daily'`
   - Verify job exists with schedule '0 6 * * *'

5. **Manual Refresh Test** (optional):
   - Trigger manual refresh via curl or SQL
   - Verify Edge Function logs show execution
   - Verify jobs table updated with new last_seen timestamp
  </how-to-verify>
  <resume-signal>Type "approved" if performance improved and all features work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Frontend loads jobs from Supabase cache (Network tab shows no JSearch requests)
2. Page load time under 2 seconds
3. Kanban board displays correctly with jobs in proper lanes
4. Click tracking and lane migrations work as before
5. pg_cron job scheduled for daily 6 AM UTC refresh
6. Manual refresh endpoint works for debugging
</verification>

<success_criteria>
- Page load time < 2 seconds (verified by user)
- No JSearch API calls from frontend
- All existing features (lanes, clicks, badges) work correctly
- Automated daily job refresh configured
- Phase 2.5 performance goal achieved
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-backend-job-caching/02.5-02-SUMMARY.md`
</output>
