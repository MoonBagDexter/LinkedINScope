---
phase: 03-real-time-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/supabase.ts
  - src/hooks/usePresence.ts
  - src/hooks/useRealtimeSync.ts
  - src/components/Header.tsx
autonomous: true

must_haves:
  truths:
    - "Live user count displayed in header as 'X degens online'"
    - "Supabase client configured with eventsPerSecond throttling"
    - "Real-time sync hook exists for job update broadcasts"
  artifacts:
    - path: "src/services/supabase.ts"
      provides: "Throttled Supabase client"
      contains: "eventsPerSecond"
    - path: "src/hooks/usePresence.ts"
      provides: "Live user count tracking"
      exports: ["usePresence"]
    - path: "src/hooks/useRealtimeSync.ts"
      provides: "Real-time job update subscription"
      exports: ["useRealtimeSync"]
    - path: "src/components/Header.tsx"
      provides: "User count display"
      contains: "degens online"
  key_links:
    - from: "src/hooks/usePresence.ts"
      to: "src/services/supabase.ts"
      via: "supabase.channel('lobby')"
      pattern: "channel\\('lobby'\\)"
    - from: "src/hooks/useRealtimeSync.ts"
      to: "src/services/supabase.ts"
      via: "supabase.channel('jobs-updates')"
      pattern: "channel\\('jobs-updates'\\)"
    - from: "src/components/Header.tsx"
      to: "src/hooks/usePresence.ts"
      via: "usePresence hook import"
      pattern: "usePresence\\(\\)"
---

<objective>
Set up real-time infrastructure: Configure Supabase client with message throttling, create presence tracking hook for live user count, and create real-time sync hook for job updates.

Purpose: Enable real-time features while staying within Supabase free tier message quotas (100 msg/sec). Presence tracking provides multi-user awareness ("X degens online"), and the sync hook enables live job updates.
Output: Throttled Supabase client, usePresence hook integrated into Header, useRealtimeSync hook ready for wiring.
</objective>

<execution_context>
@C:\Users\thedi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thedi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-polish/03-CONTEXT.md
@.planning/phases/03-real-time-polish/03-RESEARCH.md

# Key source files
@src/services/supabase.ts
@src/components/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Supabase client with realtime throttling</name>
  <files>src/services/supabase.ts</files>
  <action>
Update the Supabase client configuration to add realtime throttling.

Add `realtime` options to the createClient call:
```typescript
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  realtime: {
    params: {
      eventsPerSecond: 2, // Reduce from default 10 for quota safety
    },
  },
});
```

This reduces message throughput to 2 events/second (vs default 10), protecting against quota overages with multiple concurrent users. The RESEARCH.md recommends this conservative setting.

Do NOT change any other configuration or add any other options.
  </action>
  <verify>
File contains `eventsPerSecond: 2` inside realtime.params configuration.
TypeScript compiles without errors: `npm run build` succeeds.
  </verify>
  <done>Supabase client configured with eventsPerSecond: 2 throttling for quota safety.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePresence hook for live user count</name>
  <files>src/hooks/usePresence.ts</files>
  <action>
Create a new hook that tracks connected users using Supabase Presence API.

Implementation requirements:
1. Subscribe to a 'lobby' channel
2. Track presence on SUBSCRIBED status
3. Listen for 'sync' events to count users via `channel.presenceState()`
4. Return the user count as a number
5. Clean up subscription in useEffect cleanup (both untrack and unsubscribe)
6. Do NOT include wallet address in presence data (anonymous per CONTEXT.md)

Pattern from RESEARCH.md:
```typescript
const channel = supabase.channel('lobby');

channel
  .on('presence', { event: 'sync' }, () => {
    const state = channel.presenceState();
    setUserCount(Object.keys(state).length);
  })
  .subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      await channel.track({
        online_at: new Date().toISOString(),
      });
    }
  });

return () => {
  channel.untrack();
  channel.unsubscribe();
};
```

Export the hook as `usePresence`.
  </action>
  <verify>
File exists at src/hooks/usePresence.ts.
Exports usePresence function.
Has proper useEffect cleanup with untrack() and unsubscribe().
TypeScript compiles: `npm run build` succeeds.
  </verify>
  <done>usePresence hook created, subscribes to 'lobby' channel, returns user count, properly cleans up.</done>
</task>

<task type="auto">
  <name>Task 3: Create useRealtimeSync hook and integrate usePresence into Header</name>
  <files>src/hooks/useRealtimeSync.ts, src/components/Header.tsx</files>
  <action>
**Part A: Create useRealtimeSync hook**

Create a new hook that listens for job update broadcasts and invalidates React Query cache.

Implementation requirements:
1. Subscribe to 'jobs-updates' channel
2. Listen for 'broadcast' events with type 'job-migrated'
3. On receiving event, invalidate 'cached-jobs' query using queryClient.invalidateQueries
4. Use refetchType: 'active' to only refetch if query is currently active
5. Clean up subscription in useEffect cleanup
6. Accept optional callback for showing migration toasts

Pattern from RESEARCH.md:
```typescript
const channel = supabase
  .channel('jobs-updates')
  .on('broadcast', { event: 'job-migrated' }, (payload) => {
    queryClient.invalidateQueries({
      queryKey: ['cached-jobs'],
      refetchType: 'active',
    });
    // Call optional migration callback if provided
    onMigration?.(payload);
  })
  .subscribe();

return () => channel.unsubscribe();
```

Export as `useRealtimeSync(onMigration?: (payload: any) => void)`.

**Part B: Integrate usePresence into Header**

Update Header.tsx to display live user count:

1. Import usePresence from hooks
2. Call usePresence() to get userCount
3. Add display element between wallet address and WalletMultiButton:
```tsx
<span className="text-sm text-purple-300 font-medium">
  {userCount} {userCount === 1 ? 'degen' : 'degens'} online
</span>
```

Position it in the flex container with gap, visible on all screen sizes.
  </action>
  <verify>
src/hooks/useRealtimeSync.ts exists and exports useRealtimeSync.
src/components/Header.tsx imports and uses usePresence.
Header shows "X degens online" text.
TypeScript compiles: `npm run build` succeeds.
  </verify>
  <done>useRealtimeSync hook created for job update broadcasts, Header displays live user count as "X degens online".</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` succeeds with no TypeScript errors
2. `npm run dev` shows Header with "X degens online" (starts at 1 for current user)
3. Opening second browser tab shows count increase to 2
4. Closing tab decreases count back to 1
5. No console errors related to Supabase realtime
</verification>

<success_criteria>
- Supabase client has eventsPerSecond: 2 throttling configured
- usePresence hook tracks and returns connected user count
- useRealtimeSync hook subscribes to job-updates broadcast channel
- Header displays "X degens online" using usePresence hook
- All hooks properly clean up subscriptions on unmount
- Application builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-polish/03-01-SUMMARY.md`
</output>
