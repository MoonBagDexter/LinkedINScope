---
phase: 03-real-time-polish
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - src/components/KanbanBoard.tsx
  - src/hooks/useClickTracking.ts
autonomous: false

must_haves:
  truths:
    - "When one user causes a migration, other users see it within 2 seconds"
    - "Click count updates sync across users every 2-5 seconds"
    - "After going offline and reconnecting, users see fresh state"
    - "Click tracking broadcasts migration events to all users"
  artifacts:
    - path: "src/components/KanbanBoard.tsx"
      provides: "Integrated real-time sync with reconnect handling"
      contains: "useRealtimeSync"
    - path: "src/hooks/useClickTracking.ts"
      provides: "Broadcast migration events on click"
      contains: "channel.send"
  key_links:
    - from: "src/components/KanbanBoard.tsx"
      to: "src/hooks/useRealtimeSync.ts"
      via: "useRealtimeSync hook call"
      pattern: "useRealtimeSync\\("
    - from: "src/hooks/useClickTracking.ts"
      to: "supabase broadcast"
      via: "channel.send on migration"
      pattern: "channel\\.send"
    - from: "src/components/KanbanBoard.tsx"
      to: "window online event"
      via: "addEventListener for reconnect"
      pattern: "addEventListener.*online"
---

<objective>
Wire real-time sync to KanbanBoard, broadcast migrations from click tracking, and add offline reconnect handling. Complete the real-time loop where one user's click propagates to all users.

Purpose: Close the real-time loop. Plan 01 created the subscription hooks, Plan 02 added animations. This plan connects them so migrations actually propagate and trigger the animations.
Output: Working real-time lane migrations visible to all users within 2 seconds.
</objective>

<execution_context>
@C:\Users\thedi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thedi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-polish/03-CONTEXT.md
@.planning/phases/03-real-time-polish/03-RESEARCH.md

# Prior plan outputs (REQUIRED - these create the hooks we wire here)
@.planning/phases/03-real-time-polish/03-01-SUMMARY.md
@.planning/phases/03-real-time-polish/03-02-SUMMARY.md

# Key source files
@src/components/KanbanBoard.tsx
@src/hooks/useClickTracking.ts
@src/hooks/useRealtimeSync.ts
@src/services/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Broadcast migration events from click tracking and wire KanbanBoard</name>
  <files>src/hooks/useClickTracking.ts, src/components/KanbanBoard.tsx</files>
  <action>
**Part A: Broadcast migration events in useClickTracking**

When a click causes a lane migration, broadcast the event to all users.

1. Import supabase client at top of useClickTracking.ts:
```typescript
import { supabase } from '../services/supabase';
```

2. In the onSuccess callback, after handling the toast, broadcast migration events:
```typescript
onSuccess: (data, variables) => {
  // ... existing toast logic ...

  // Broadcast migration event to all users
  if (data.newLane === 'trending' || data.newLane === 'graduated') {
    supabase.channel('jobs-updates').send({
      type: 'broadcast',
      event: 'job-migrated',
      payload: {
        jobId: variables.jobId,
        jobTitle: variables.jobTitle,
        newLane: data.newLane,
        clickCount: data.clickCount,
      },
    });
  }

  // ... existing invalidation logic ...
}
```

Note: The channel needs to be subscribed before sending. To ensure this, get or create the channel:
```typescript
const channel = supabase.channel('jobs-updates');
channel.subscribe().then(() => {
  channel.send({
    type: 'broadcast',
    event: 'job-migrated',
    payload: { ... },
  });
});
```

Better pattern - use the existing subscribed channel. Since useRealtimeSync already subscribes to this channel, we need to ensure we're using the same channel instance or that the channel allows sending without being subscribed from this location.

Actually, Supabase Broadcast allows sending to a channel without being subscribed to it - the server routes messages to all subscribers. So the simple approach works:

```typescript
if (data.newLane === 'trending' || data.newLane === 'graduated') {
  const channel = supabase.channel('jobs-updates');
  channel.send({
    type: 'broadcast',
    event: 'job-migrated',
    payload: {
      jobId: variables.jobId,
      jobTitle: variables.jobTitle,
      newLane: data.newLane,
      clickCount: data.clickCount,
    },
  });
}
```

**Part B: Wire useRealtimeSync in KanbanBoard**

1. Import useRealtimeSync:
```typescript
import { useRealtimeSync } from '../hooks/useRealtimeSync';
```

2. Call useRealtimeSync with a callback to show toast for OTHER users' migrations:
```typescript
// Real-time sync for other users' migrations
useRealtimeSync((payload) => {
  // Show toast for migrations caused by OTHER users
  // (Our own migrations already show toast in useClickTracking)
  // We can't easily distinguish, so we'll let React Query dedup the data
  // and the animations will handle the visual update
});
```

Actually, the useRealtimeSync hook already invalidates the cached-jobs query, which triggers a refetch. The animation logic in KanbanLane (from Plan 02) will detect new jobs and animate them. So we just need to call the hook:

```typescript
// Enable real-time sync - invalidates cache when other users cause migrations
useRealtimeSync();
```

If we want to show toasts for OTHER users' migrations (not just our own), we can pass a callback:
```typescript
useRealtimeSync((payload) => {
  // This fires for all migrations including our own
  // Our own already showed toast, so we need to dedupe
  // For simplicity, let animations be the feedback for other users' actions
  // (toasts only for our own clicks)
});
```

Keep it simple - just wire the hook without callback. The cache invalidation triggers refetch, which triggers animations.

**Part C: Add offline/reconnect handling in KanbanBoard**

Add a useEffect that refetches jobs when the browser comes back online:

```typescript
import { useQueryClient } from '@tanstack/react-query';

// Inside KanbanBoard component:
const queryClient = useQueryClient();

// Reconnect handling - refetch when coming back online
useEffect(() => {
  const handleOnline = () => {
    queryClient.invalidateQueries({ queryKey: ['cached-jobs'] });
  };

  window.addEventListener('online', handleOnline);
  return () => window.removeEventListener('online', handleOnline);
}, [queryClient]);
```

This ensures users see fresh state after network reconnection without jarring catch-up animations (per CONTEXT.md decision: "Offline handling: Fetch fresh state silently on reconnect").
  </action>
  <verify>
useClickTracking broadcasts 'job-migrated' event on lane migrations.
KanbanBoard imports and calls useRealtimeSync.
KanbanBoard has online event listener for reconnect handling.
TypeScript compiles: `npm run build` succeeds.
  </verify>
  <done>Real-time loop complete: clicks broadcast migrations, KanbanBoard subscribes to updates, reconnect refetches fresh state.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete real-time lane migration system with animations and multi-user sync:
- Live user count in header ("X degens online")
- Cards animate when migrating between lanes (250ms slide)
- Progress bars pulse with warm colors at 80%+ threshold
- Degen-style toast messages ("LFG!", "to the moon!")
- Real-time updates across browser tabs/users within 2 seconds
- Offline reconnect handling
  </what-built>
  <how-to-verify>
**Test 1: Live User Count**
1. Run `npm run dev` and open http://localhost:5173
2. Check header shows "1 degen online" (or similar count)
3. Open a second browser tab to same URL
4. Verify count increases to "2 degens online" in both tabs
5. Close one tab, verify count decreases

**Test 2: Progress Bar Near-Threshold**
1. Find a job with 4/5 clicks (or modify in Supabase dashboard: UPDATE jobs SET click_count = 4 WHERE lane = 'new' LIMIT 1)
2. Verify progress bar shows yellow/orange gradient
3. Verify progress bar is pulsing
4. Verify text shows "4 clicks - Almost there!"

**Test 3: Real-Time Migration (requires two browser windows)**
1. Open two browser windows side by side, both logged in with Phantom
2. In Window A, click Quick Apply on a job that's at threshold (e.g., 4/5 clicks for Trending)
3. Observe in Window A: Toast shows "LFG! Job is pumping"
4. Observe in Window B: Job card animates into Trending lane within 2 seconds
5. Both windows should show updated job in Trending lane

**Test 4: Animations**
1. When a job migrates (from test above), verify card slides in smoothly (not instant)
2. Animation should be quick (~250ms) and snappy, not slow

**Test 5: Toast Configuration**
1. Rapidly click Quick Apply on multiple jobs
2. Verify max 3 toasts visible at once
3. Verify toasts auto-dismiss after ~4 seconds

**Test 6: Offline/Reconnect**
1. Open browser dev tools -> Network tab
2. Set to "Offline" mode
3. Have another user (or second window online) cause a migration
4. Set back to "Online"
5. Verify jobs refetch and show current state (no jarring animations on reconnect)

**Expected degen toast messages:**
- Click on job: "Click recorded, fren"
- Job hits Trending: "LFG! Job is pumping"
- Job graduates: "Job to the moon!"
- Already clicked: "Already sent it, anon"
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Complete when human verifies:
1. User count displays correctly and updates across tabs
2. Progress bars show near-threshold emphasis at 80%+
3. Real-time migrations propagate to other users within 2 seconds
4. Card animations play smoothly when jobs migrate
5. Toast messages use degen slang
6. Offline/reconnect refetches fresh state
</verification>

<success_criteria>
- Real-time migration events broadcast from click tracking
- KanbanBoard subscribes to real-time updates
- Reconnect handling invalidates cache on network restore
- Human verified: all real-time features work as expected
- KANB-03 satisfied: Lane migrations update in real-time for all users
- KANB-04 satisfied: Cards animate when moving between lanes
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-polish/03-03-SUMMARY.md`
</output>
