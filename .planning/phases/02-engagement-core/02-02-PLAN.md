---
phase: 02-engagement-core
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/KanbanBoard.tsx
  - src/components/KanbanLane.tsx
  - src/components/ProgressBar.tsx
  - src/components/MobileTabNav.tsx
  - src/hooks/useLaneJobs.ts
  - src/App.tsx
  - src/main.tsx
autonomous: false

must_haves:
  truths:
    - "User can see jobs organized in three lanes on desktop (side-by-side columns)"
    - "User can switch between lanes on mobile using tabs"
    - "User can see progress bar showing clicks toward next threshold"
    - "Jobs instantly move to new lane when click threshold is crossed"
    - "Toast notification appears when job migrates to new lane"
  artifacts:
    - path: "src/components/KanbanBoard.tsx"
      provides: "Three-lane Kanban layout with responsive behavior"
      exports: ["KanbanBoard"]
    - path: "src/components/KanbanLane.tsx"
      provides: "Individual lane rendering jobs"
      exports: ["KanbanLane"]
    - path: "src/components/ProgressBar.tsx"
      provides: "Visual progress toward next threshold"
      exports: ["ProgressBar"]
    - path: "src/hooks/useLaneJobs.ts"
      provides: "Fetch jobs by lane from Supabase"
      exports: ["useLaneJobs"]
  key_links:
    - from: "src/components/KanbanBoard.tsx"
      to: "src/hooks/useLaneJobs.ts"
      via: "useLaneJobs hook for each lane"
      pattern: "useLaneJobs\\('new'\\)|useLaneJobs\\('trending'\\)|useLaneJobs\\('graduated'\\)"
    - from: "src/components/KanbanLane.tsx"
      to: "src/components/JobCard.tsx"
      via: "renders JobCard for each job"
      pattern: "<JobCard"
    - from: "src/App.tsx"
      to: "src/components/KanbanBoard.tsx"
      via: "replaces JobList with KanbanBoard"
      pattern: "<KanbanBoard"
    - from: "src/main.tsx"
      to: "sonner"
      via: "Toaster component for notifications"
      pattern: "<Toaster"
---

<objective>
Build the three-lane Kanban board UI with responsive layout (desktop columns, mobile tabs) and integrate click tracking with toast notifications for lane migrations. Replace the Phase 1 JobList with the full Kanban experience.

Purpose: Deliver the visual interface where users see jobs organized by community engagement, with real-time feedback when their clicks trigger migrations.

Output: Working Kanban board with all three lanes, progress bars, mobile tabs, click tracking integration, and migration toast notifications.
</objective>

<execution_context>
@C:\Users\thedi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thedi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-engagement-core/02-CONTEXT.md
@.planning/phases/02-engagement-core/02-RESEARCH.md

# Prior plan artifacts
@.planning/phases/02-engagement-core/02-01-SUMMARY.md

# Source files to modify/reference
@src/App.tsx
@src/main.tsx
@src/components/JobCard.tsx
@src/types/kanban.ts
@src/hooks/useJobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Kanban Components (Board, Lane, ProgressBar, MobileTabNav)</name>
  <files>
    src/components/KanbanBoard.tsx
    src/components/KanbanLane.tsx
    src/components/ProgressBar.tsx
    src/components/MobileTabNav.tsx
    src/hooks/useLaneJobs.ts
  </files>
  <action>
1. Create `src/hooks/useLaneJobs.ts`:
   - Fetch jobs from Supabase for a specific lane
   - Use React Query with queryKey ['lane-jobs', lane]
   - Query: `supabase.from('jobs').select('*').eq('lane', lane).order('created_at', { ascending: false })`
   - Return { jobs, isLoading, error, refetch }
   - Note: For Phase 2, we need to also merge JSearch API data with Supabase lane data

   Alternative simpler approach for now:
   - Fetch ALL jobs from JSearch API (existing useJobs hook)
   - Fetch lane data from Supabase (job_id -> lane mapping)
   - Combine client-side: assign lane to each job, group by lane
   - This avoids duplicating job content in Supabase

   Implement the simpler approach:
   ```typescript
   // src/hooks/useLaneJobs.ts
   import { useJobs } from './useJobs';
   import { useQuery } from '@tanstack/react-query';
   import { supabase } from '../services/supabase';
   import type { Job } from '../types/job';
   import type { Lane, JobWithLane } from '../types/kanban';

   export function useLaneJobs() {
     // Fetch jobs from JSearch API
     const { jobs: apiJobs, isLoading: apiLoading, error: apiError } = useJobs();

     // Fetch lane assignments from Supabase
     const { data: laneData, isLoading: laneLoading } = useQuery({
       queryKey: ['job-lanes'],
       queryFn: async () => {
         const { data, error } = await supabase
           .from('jobs')
           .select('job_id, lane, click_count');
         if (error) throw error;
         return data as { job_id: string; lane: Lane; click_count: number }[];
       }
     });

     // Combine: assign lane to each job, default to 'new' if not in Supabase yet
     const jobsByLane = useMemo(() => {
       if (!apiJobs) return { new: [], trending: [], graduated: [] };

       const laneMap = new Map(laneData?.map(l => [l.job_id, l]) ?? []);

       const result: Record<Lane, (Job & { click_count: number })[]> = {
         new: [],
         trending: [],
         graduated: []
       };

       for (const job of apiJobs) {
         const laneInfo = laneMap.get(job.job_id);
         const lane = laneInfo?.lane ?? 'new';
         const click_count = laneInfo?.click_count ?? 0;
         result[lane].push({ ...job, click_count });
       }

       return result;
     }, [apiJobs, laneData]);

     return {
       jobsByLane,
       isLoading: apiLoading || laneLoading,
       error: apiError
     };
   }
   ```

2. Create `src/components/ProgressBar.tsx`:
   - Props: current (number), threshold (number), variant ('new' | 'trending')
   - Show progress bar with gradient colors (blue-purple for new, purple-pink for trending)
   - Display: "{current} clicks" and "{remaining} to go"
   - Per CONTEXT.md: Thresholds hidden from users, so show "X clicks" without denominator
   - Actually show relative progress without exact threshold: "{current} clicks - {percentage}% there"
   - Graduated lane: No progress bar, show "Graduated" badge instead
   - Use Tailwind for styling, match degen aesthetic

3. Create `src/components/MobileTabNav.tsx`:
   - Props: activeLane (Lane), onLaneChange (lane: Lane) => void
   - Three tabs: "New Listings", "Trending", "Graduated"
   - Active tab: purple underline, white text
   - Inactive tabs: gray text
   - Only visible on mobile (md:hidden)

4. Create `src/components/KanbanLane.tsx`:
   - Props: lane (Lane), jobs (Job & { click_count: number })[], title (string), walletAddress?: string, clickedJobIds?: string[], onApplyClick, onMigration
   - Render lane header (simple text label per CONTEXT.md)
   - Map over jobs, render JobCard for each
   - Pass hasClicked={clickedJobIds?.includes(job.job_id)} to each JobCard
   - Add ProgressBar below each JobCard (except for Graduated lane)

5. Create `src/components/KanbanBoard.tsx`:
   - Use useLaneJobs hook to get jobsByLane
   - Use useUserClicks hook to get clickedJobIds
   - Use useWallet from @solana/wallet-adapter-react for wallet address
   - Use useClickTracking hook for tracking clicks
   - Desktop layout: CSS Grid 3 columns (md:grid-cols-3)
   - Mobile: useState for activeMobileLane, show only active lane
   - Include MobileTabNav for mobile
   - Handle onApplyClick:
     a. If wallet connected, call trackClick mutation
     b. Open external link (window.open)
     c. If mutation returns newLane, call onMigration callback
   - Pass onMigration callback that shows toast notification
  </action>
  <verify>
    - `npm run build` compiles without errors
    - All components export correctly
    - KanbanBoard shows three lanes on desktop viewport
    - KanbanBoard shows tabs on mobile viewport
    - ProgressBar displays current clicks
  </verify>
  <done>
    - ProgressBar shows click progress toward migration
    - MobileTabNav allows switching between lanes on mobile
    - KanbanLane renders jobs with click status
    - KanbanBoard orchestrates layout and click tracking
    - useLaneJobs combines JSearch data with Supabase lane assignments
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate KanbanBoard into App and Add Toast Notifications</name>
  <files>
    src/App.tsx
    src/main.tsx
  </files>
  <action>
1. Update `src/main.tsx`:
   - Import { Toaster } from 'sonner'
   - Add <Toaster position="top-right" theme="dark" /> inside the root render
   - Position it before <App /> so toasts appear above all content

2. Update `src/App.tsx`:
   - Remove JobList import
   - Import KanbanBoard
   - Replace <JobList /> with <KanbanBoard />
   - The KanbanBoard component handles all the job display, lane organization, and click tracking
   - Wrap KanbanBoard in a container if needed for layout

3. Update KanbanBoard to handle migration notifications:
   - When useClickTracking mutation returns a newLane, show toast:
     ```typescript
     import { toast } from 'sonner';

     // In the click handler's onSuccess
     if (result.newLane) {
       const laneNames = { trending: 'Trending', graduated: 'Graduated' };
       toast.success(`Job moved to ${laneNames[result.newLane]}!`, {
         description: 'This job is gaining traction from the community',
         duration: 4000,
       });
     }
     ```

4. Ensure proper error handling:
   - If click tracking fails, show error toast
   - If job data fails to load, show loading/error state in KanbanBoard
  </action>
  <verify>
    - `npm run build` compiles without errors
    - App renders KanbanBoard instead of JobList
    - Toaster component is mounted in main.tsx
    - Toast notification appears when job migrates (can test with mock/manual trigger)
  </verify>
  <done>
    - KanbanBoard replaces JobList in main app
    - Toast notifications configured for lane migrations
    - Error states handled gracefully
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Three-lane Kanban board with:
- Desktop: Three columns side-by-side (New Listings, Trending, Graduated)
- Mobile: Tab navigation to switch between lanes
- Progress bars showing click progress on each job card
- "Already applied" badge on clicked jobs (if wallet connected)
- Toast notification when clicking triggers lane migration
- Click tracking integrated with Quick Apply button
  </what-built>
  <how-to-verify>
1. **Prerequisites:**
   - Ensure Supabase project is created and database tables are set up (see user_setup in Plan 02-01)
   - Ensure .env.local has: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY, VITE_JSEARCH_API_KEY
   - Add threshold vars: VITE_THRESHOLD_NEW_TO_TRENDING=5, VITE_THRESHOLD_TRENDING_TO_GRADUATED=20

2. **Start dev server:** `npm run dev`

3. **Desktop Layout Test:**
   - Open browser at wide viewport (>768px)
   - Verify three columns visible: "New Listings", "Trending", "Graduated"
   - All jobs should appear in "New Listings" initially
   - Each job card shows progress bar with click count

4. **Mobile Layout Test:**
   - Resize browser to narrow viewport (<768px)
   - Verify tabs appear at top: "New", "Trending", "Graduated"
   - Only one lane visible at a time
   - Tapping tabs switches lanes

5. **Click Tracking Test:**
   - Connect Phantom wallet
   - Click Quick Apply on a job
   - Verify external job link opens
   - Verify "Already applied" badge appears on clicked job
   - Clicking same job again should still work but not double-count

6. **Migration Test:**
   - Create test scenario: manually set a job's click_count to 4 in Supabase
   - Click Quick Apply on that job
   - Verify toast notification appears: "Job moved to Trending!"
   - Verify job appears in Trending lane

7. **Error Handling:**
   - Disconnect wallet, try to click Quick Apply
   - Verify click still opens external link (tracking skipped without wallet)
   - Verify no crashes
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks including human verification:

1. **Functional:**
   - Three-lane Kanban board visible on desktop
   - Mobile tabs work for lane switching
   - Progress bars show click counts
   - Click tracking records to Supabase
   - Lane migration triggers toast notification
   - "Already applied" badge shows for clicked jobs

2. **Technical:**
   - `npm run build` passes
   - No console errors in browser
   - React Query properly invalidates after mutations
   - Supabase queries return expected data

3. **UX:**
   - Layout matches CONTEXT.md decisions (three equal columns, mobile tabs)
   - Progress bars visible but don't reveal exact thresholds
   - Degen aesthetic maintained (dark theme, purple accents)
</verification>

<success_criteria>
- [ ] KanbanBoard component renders three lanes on desktop
- [ ] MobileTabNav allows switching lanes on mobile
- [ ] ProgressBar shows click progress (without revealing threshold)
- [ ] Click tracking mutation fires on Quick Apply with wallet connected
- [ ] Lane migration happens instantly when threshold crossed
- [ ] Toast notification appears on migration
- [ ] "Already applied" badge visible on clicked jobs
- [ ] JobList replaced with KanbanBoard in App.tsx
- [ ] Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/02-engagement-core/02-02-SUMMARY.md`
</output>
