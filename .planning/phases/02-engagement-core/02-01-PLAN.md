---
phase: 02-engagement-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/supabase.ts
  - src/services/clickTracker.ts
  - src/hooks/useClickTracking.ts
  - src/hooks/useUserClicks.ts
  - src/components/JobCard.tsx
  - src/types/kanban.ts
  - src/vite-env.d.ts
  - .env.example
autonomous: true
user_setup:
  - service: supabase
    why: "Database for click tracking and job lane state"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: VITE_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Create jobs table with lane column"
        location: "Supabase Dashboard -> SQL Editor"
        sql: |
          CREATE TABLE jobs (
            job_id TEXT PRIMARY KEY,
            lane TEXT NOT NULL DEFAULT 'new' CHECK (lane IN ('new', 'trending', 'graduated')),
            click_count INTEGER NOT NULL DEFAULT 0,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            updated_at TIMESTAMPTZ DEFAULT NOW()
          );
          ALTER TABLE jobs ENABLE ROW LEVEL SECURITY;
          CREATE POLICY "Anyone can read jobs" ON jobs FOR SELECT USING (true);
          CREATE POLICY "Anyone can insert jobs" ON jobs FOR INSERT WITH CHECK (true);
          CREATE POLICY "Anyone can update jobs" ON jobs FOR UPDATE USING (true);
      - task: "Create clicks table with anti-gaming constraint"
        location: "Supabase Dashboard -> SQL Editor"
        sql: |
          CREATE TABLE clicks (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            job_id TEXT NOT NULL REFERENCES jobs(job_id),
            wallet_address TEXT NOT NULL,
            clicked_at TIMESTAMPTZ DEFAULT NOW(),
            CONSTRAINT unique_wallet_job UNIQUE (wallet_address, job_id)
          );
          CREATE INDEX idx_clicks_job_id ON clicks(job_id);
          CREATE INDEX idx_clicks_wallet ON clicks(wallet_address);
          ALTER TABLE clicks ENABLE ROW LEVEL SECURITY;
          CREATE POLICY "Anyone can read clicks" ON clicks FOR SELECT USING (true);
          CREATE POLICY "Anyone can insert clicks" ON clicks FOR INSERT WITH CHECK (true);
      - task: "Enable Realtime for jobs table"
        location: "Supabase Dashboard -> Database -> Publications"
        steps: "Add jobs table to supabase_realtime publication OR run: ALTER PUBLICATION supabase_realtime ADD TABLE jobs;"

must_haves:
  truths:
    - "System records click with wallet and job ID when user clicks Quick Apply"
    - "User cannot register duplicate clicks for same job"
    - "User sees 'Already applied' badge on jobs they've clicked"
    - "Click count increments in database after successful click"
  artifacts:
    - path: "src/services/supabase.ts"
      provides: "Supabase client singleton"
      contains: "createClient"
    - path: "src/services/clickTracker.ts"
      provides: "Click tracking database operations"
      exports: ["recordClick", "getClickCount", "hasUserClicked"]
    - path: "src/hooks/useClickTracking.ts"
      provides: "React Query mutation for click tracking"
      exports: ["useClickTracking"]
    - path: "src/hooks/useUserClicks.ts"
      provides: "Fetch user's clicked jobs"
      exports: ["useUserClicks"]
    - path: "src/types/kanban.ts"
      provides: "Lane enum and types"
      exports: ["Lane", "JobWithLane"]
  key_links:
    - from: "src/components/JobCard.tsx"
      to: "src/hooks/useClickTracking.ts"
      via: "useClickTracking hook call on Quick Apply"
      pattern: "useClickTracking"
    - from: "src/hooks/useClickTracking.ts"
      to: "src/services/clickTracker.ts"
      via: "mutation calls recordClick"
      pattern: "recordClick"
    - from: "src/services/clickTracker.ts"
      to: "src/services/supabase.ts"
      via: "supabase.from('clicks').insert"
      pattern: "supabase\\.from.*clicks"
---

<objective>
Set up Supabase client and implement click tracking with anti-gaming enforcement via database unique constraints. Clicks are recorded only when user actually visits the external job page, and each wallet can only click each job once.

Purpose: Enable the engagement tracking that powers the core differentiator - jobs rising based on real community clicks, not algorithms.

Output: Working click tracking system with optimistic updates, user click history, and "Already applied" badges on clicked jobs.
</objective>

<execution_context>
@C:\Users\thedi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thedi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-engagement-core/02-CONTEXT.md
@.planning/phases/02-engagement-core/02-RESEARCH.md

# Phase 1 artifacts (click tracking foundation)
@src/components/JobCard.tsx
@src/types/job.ts
@src/vite-env.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase Client and Types</name>
  <files>
    src/services/supabase.ts
    src/types/kanban.ts
    src/vite-env.d.ts
    .env.example
  </files>
  <action>
1. Install Supabase client:
   ```bash
   npm install @supabase/supabase-js sonner
   ```

2. Create `src/services/supabase.ts`:
   - Import createClient from @supabase/supabase-js
   - Create singleton client using VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY
   - Export the client

3. Create `src/types/kanban.ts`:
   ```typescript
   export type Lane = 'new' | 'trending' | 'graduated';

   export interface JobWithLane {
     job_id: string;
     lane: Lane;
     click_count: number;
     created_at: string;
     updated_at: string;
   }

   export interface Click {
     id: string;
     job_id: string;
     wallet_address: string;
     clicked_at: string;
   }
   ```

4. Update `src/vite-env.d.ts` to add environment variable types:
   - VITE_SUPABASE_URL: string
   - VITE_SUPABASE_ANON_KEY: string
   - VITE_THRESHOLD_NEW_TO_TRENDING: string
   - VITE_THRESHOLD_TRENDING_TO_GRADUATED: string

5. Update `.env.example` with new variables (copy from existing, add Supabase vars and threshold vars with defaults 5 and 20)
  </action>
  <verify>
    - `npm run build` compiles without errors
    - `src/services/supabase.ts` exports supabase client
    - `src/types/kanban.ts` exports Lane and JobWithLane types
    - `.env.example` contains all required environment variables
  </verify>
  <done>
    - Supabase client configured and exported
    - Kanban types defined
    - Environment variable types declared
    - .env.example updated with all required vars
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Click Tracking Service and Hooks</name>
  <files>
    src/services/clickTracker.ts
    src/hooks/useClickTracking.ts
    src/hooks/useUserClicks.ts
  </files>
  <action>
1. Create `src/services/clickTracker.ts`:
   ```typescript
   import { supabase } from './supabase';
   import type { JobWithLane } from '../types/kanban';

   // Get current thresholds from environment (parse to numbers!)
   const THRESHOLD_NEW_TO_TRENDING = parseInt(import.meta.env.VITE_THRESHOLD_NEW_TO_TRENDING || '5', 10);
   const THRESHOLD_TRENDING_TO_GRADUATED = parseInt(import.meta.env.VITE_THRESHOLD_TRENDING_TO_GRADUATED || '20', 10);

   // Upsert job if it doesn't exist (from JSearch API data)
   export async function ensureJobExists(jobId: string): Promise<void>

   // Record a click - returns { success, alreadyClicked, newLane }
   // - Insert click (fails silently on duplicate due to unique constraint)
   // - Increment click_count on jobs table
   // - Check if threshold crossed, update lane if needed
   // - Return result with newLane if migration happened
   export async function recordClick(jobId: string, walletAddress: string): Promise<{
     success: boolean;
     alreadyClicked: boolean;
     newLane?: 'new' | 'trending' | 'graduated';
     clickCount: number;
   }>

   // Check if user has already clicked a job
   export async function hasUserClicked(jobId: string, walletAddress: string): Promise<boolean>

   // Get all job IDs user has clicked
   export async function getUserClickedJobs(walletAddress: string): Promise<string[]>

   // Get click count for a job
   export async function getClickCount(jobId: string): Promise<number>

   // Get job lane status
   export async function getJobLane(jobId: string): Promise<JobWithLane | null>
   ```

   Important implementation details:
   - Use `onConflict: 'ignore'` or handle unique constraint error gracefully for duplicate clicks
   - Migration logic: if click_count >= THRESHOLD_NEW_TO_TRENDING and lane === 'new', update to 'trending'
   - Migration logic: if click_count >= THRESHOLD_TRENDING_TO_GRADUATED and lane === 'trending', update to 'graduated'
   - Return newLane in response so UI can show toast

2. Create `src/hooks/useClickTracking.ts`:
   - Use useMutation from @tanstack/react-query
   - Call recordClick from clickTracker service
   - On success: invalidate queries for ['lane-jobs'] and ['user-clicks']
   - Return { trackClick, isTracking, error }

3. Create `src/hooks/useUserClicks.ts`:
   - Use useQuery from @tanstack/react-query
   - Fetch user's clicked jobs using getUserClickedJobs
   - queryKey: ['user-clicks', walletAddress]
   - Return { clickedJobIds, isLoading }
   - Skip query if no wallet connected (enabled: !!walletAddress)
  </action>
  <verify>
    - `npm run build` compiles without TypeScript errors
    - `src/services/clickTracker.ts` exports recordClick, hasUserClicked, getUserClickedJobs
    - `src/hooks/useClickTracking.ts` exports useClickTracking hook
    - `src/hooks/useUserClicks.ts` exports useUserClicks hook
  </verify>
  <done>
    - Click tracking service handles recording, deduplication, and migration logic
    - useClickTracking hook wraps mutation with proper invalidation
    - useUserClicks hook fetches user's click history
  </done>
</task>

<task type="auto">
  <name>Task 3: Update JobCard with Click Tracking and Already Applied Badge</name>
  <files>
    src/components/JobCard.tsx
  </files>
  <action>
1. Update `src/components/JobCard.tsx`:
   - Add new props: `walletAddress?: string`, `hasClicked?: boolean`, `onMigration?: (newLane: Lane, jobTitle: string) => void`
   - Keep existing props: `job`, `onApplyClick`

2. Add "Already applied" badge:
   - When `hasClicked` is true, show a small badge/indicator on the card
   - Badge text: "Applied" with a checkmark icon
   - Style: small pill badge, green background, positioned in top-right corner of card
   - When showing badge, the Quick Apply button can still work (user can revisit)

3. Update handleApplyClick:
   - If walletAddress is provided, the parent component handles click tracking
   - Keep calling onApplyClick (which opens external link)
   - The parent (JobList or KanbanBoard) will use useClickTracking hook

4. Visual feedback:
   - If hasClicked is true, slightly dim the card border (border-green-500/30 instead of purple)
   - Button still works to revisit the job listing

Note: The actual click tracking mutation is called by parent component, not JobCard directly. JobCard just receives hasClicked as a prop and displays the badge.
  </action>
  <verify>
    - `npm run build` compiles without errors
    - JobCard accepts new props: walletAddress, hasClicked, onMigration
    - JobCard shows "Applied" badge when hasClicked is true
    - Badge is visually distinct (green, positioned top-right)
  </verify>
  <done>
    - JobCard displays "Already applied" badge for clicked jobs
    - Card styling indicates clicked state
    - Props ready for parent component to pass click status
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Build check:** `npm run build` passes with no TypeScript errors
2. **Type check:** All new types properly exported and importable
3. **Service layer:** clickTracker functions are callable (even if DB not yet configured)
4. **Hook exports:** useClickTracking and useUserClicks are importable
5. **JobCard:** Shows badge when hasClicked={true} is passed

Note: Full integration testing requires Supabase database setup (user_setup). This plan establishes the code; Plan 02-02 will integrate with the Kanban UI.
</verification>

<success_criteria>
- [ ] Supabase client singleton created and exported
- [ ] Lane types (new, trending, graduated) defined
- [ ] Click tracking service with anti-gaming logic implemented
- [ ] useClickTracking hook uses mutation with query invalidation
- [ ] useUserClicks hook fetches user's clicked job IDs
- [ ] JobCard displays "Already applied" badge when hasClicked=true
- [ ] Environment variables documented in .env.example
- [ ] All code compiles with `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/02-engagement-core/02-01-SUMMARY.md`
</output>
